<?php
function getUser()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    $email = $user->email;
    $id = $user->id;
    $db = getDB();
    $sql = "SELECT id, email, created, customer_id, subscription_id, subscription_item_id, card_id, active, mailing_list_only FROM users WHERE email= \"{$email}\" AND id = \"$id\"";
    $rows = getAllRowsOfQuery($db, $sql);
    $data = $rows[0];
    return array("status" => 200, "msg" => "Retrieved user successfully", "data" => $data, "success" => true);
}

function resetPasswordLoggedIn()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }

    $email = $user->email;
    #$id = $user->id;
    $db = getDB();
    $sql = "SELECT * FROM password_resets WHERE email=\"$email\"";
    $rows = getAllRowsOfQuery($db, $sql);
    if (!empty($rows)) {
        return array("status" => 400, "msg" => "Password reset request already exists!", "success" => false);
    }

    $reset_id = uniqid();
    $reset_token = uniqid();

    $sql = "INSERT into password_resets (id, email, reset_token, created) VALUES (\"$reset_id\", \"$email\", \"$reset_token\"
," . get_micro_time() . ")";
    if (queryDatabase($db, $sql)) {
        // SEND MAIL
        return array("status"=>200, 'msg' => 'Reset request successfully submitted! Follow email instructions', "success" => true);
    }
}

function getUpcomingInvoice()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    $id = $user->id;
    $db = getDB();
    $sql = "SELECT * FROM users WHERE id = \"$id\"";
    $rows = getAllRowsOfQuery($db, $sql);
    if (!empty($rows)) {
        $customer_id = $rows[0]["customer_id"];
        $stripe = new Stripe(getStripeConfig());
        $upcoming = json_decode($stripe->customer_upcoming_invoice($customer_id), true);

        return array("status"=>200, 'msg' => 'Retrieved upcoming invoice', "data" => $upcoming, "success" => true);
    }
}

function handlingCard()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    if (!isPost()) {
        $id = $user->id;
        $db = getDB();
        $sql = "SELECT customer_id, card_id from users where id = \"$id\"";
        $rows = getAllRowsOfQuery($db, $sql);
        $customer_id = $rows[0]["customer_id"];
        $card_id = $rows[0]["card_id"];
        if (!isset($card_id)) {
            return array("status" => 500, "msg" => "Failed to retrieve customer card", "success" => false);
        }

        $stripe = new Stripe(getStripeConfig());
        $source = $stripe->retrieve_source($customer_id, $card_id);
        return array("status"=>200, 'msg' => 'Retrieved payment source', "data" => $source, "success" => true);

    }
    $body = array_map('htmlspecialchars', $_POST);
    $params = array("tokenId");
    if (!check_isset_body($body, $params)) {
        return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
    }

    $id = $user->id;
    $token_id = $body["tokenId"];
    $db = getDB();
    $sql = "SELECT customer_id from users where id = \"$id\"";
    $rows = getAllRowsOfQuery($db, $sql);
    if (empty($rows)) {
        return array("status" => 400, "msg" => "Customer not found", "success" => false);
    }

    $customer_id = $rows[0]["customer_id"];
    $stripe = new Stripe(getStripeConfig());
    $card = json_decode($stripe->create_card($customer_id, $token_id), true);
    $updated_customer = json_decode($stripe->update_customer_source($customer_id, $card["id"]), true);
    $sql = "UPDATE users set card_id = \"{$card["id"]}\" where id = \"$user->id\"";
    queryDatabase($db, $sql);
    return array("status"=>200, 'msg' => 'Updated customer payment source', "success" => true);

}

function handlingSubscription()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    switch ($_SERVER["REQUEST_METHOD"]) {
        case 'GET':
            {
                $id = $user->id;
                $db = getDB();
                $sql = "SELECT * from users where id = \"$id\"";
                $rows = getAllRowsOfQuery($db, $sql);
                if (!empty($rows)) {
                    $subscription_item_id = $rows[0]["subscription_item_id"];
                    $stripe = new Stripe(getStripeConfig());
                    $plan_data = json_decode($stripe->get_subscription_item($subscription_item_id), true);
                    return array('msg' => 'Retrieved plan for user', "data" => array(
                        "name" => "Freelancer",
                        "subscription_item" => $plan_data
                    ), "success" => true);
                }
            }
            break;
        case 'PUT':
        {
            $body = json_decode(file_get_contents('php://input'), true);
            $params = array("plan");
            if (!check_isset_body($body, $params)) {
                return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
            }
            $plan = htmlspecialchars($body["plan"]);
            $db = getDB();
            $sql = "SELECT * FROM users WHERE id = \"{$user->id}\"";
            $rows = getAllRowsOfQuery($db, $sql);
            if (!empty($rows)) {
                $subscription_item_id = $rows[0]["subscription_item_id"];
                $stripe = new Stripe(getStripeConfig());
                $stripe->update_plan($subscription_item_id, $plan);
                return array("status" => 200, 'msg' => 'Updated subscription', "success" => true);
            }
        }

        case 'DELETE':
            {
                $sql = "SELECT * FROM users WHERE id = \"{$user->id}\"";
                $rows = getAllRowsOfQuery($db, $sql);
                if (!empty($rows)) {
                    $subscription_item_id = $rows[0]["subscription_item_id"];
                    $stripe = new Stripe(getStripeConfig());
                    $stripe->delete_subscription($subscription_item_id);
                    return array("status" => 200, 'msg' => 'Deleted subscription', "success" => true);
                }
            }
            break;

    }

}

function activateMeter()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    if (!isPost()) return array("status" => 405, "success" => false);
    $queries = array_map('htmlspecialchars', $_GET);
    $params = array("monitor_id");
    if (!check_isset_body($queries, $params)) {
        return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
    }
    $db = getDB();
    $monitor_id = mysqli_real_escape_string($db, $queries["monitor_id"]);
    $sql = "INSERT INTO active_meters (monitor_id, user_id, created, last_updated) VALUES(\"$monitor_id\", \"{$user->id}\"," . get_micro_time() . ", " . get_micro_time() . ")";
    queryDatabase($db, $sql);
    return array("status" => 200, 'msg' => 'Monitor active, monitoring usage', "success" => true);
}

function updateUsage()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    if ($_SERVER["REQUEST_METHOD"] != "PUT") return array("status" => 405, "success" => false);
    $queries = array_map('htmlspecialchars', $_GET);
    $params = array("monitor_id");
    if (!check_isset_body($queries, $params)) {
        return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
    }
    $db = getDB();
    $monitor_id = mysqli_real_escape_string($db, $queries["monitor_id"]);
    $sql = "UPDATE active_meters SET last_updated = " . get_micro_time() . " WHERE monitor_id = \"$monitor_id\" AND user_id = \"{$user->id}\"";
    queryDatabase($db, $sql);
    return array("status" => 200, 'msg' => 'Monitor updated', "success" => true);

}