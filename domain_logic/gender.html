<?php
function handlingGender()
{
    $user = verify_user_token();
    if (is_bool($user)) {
        return array("status" => 401, "success" => false);
    }
    if (!isPost()) {
        $db = getDB();
        $params = array("start", "end", "monitor_id", "duration");
        if (!check_isset_body($_GET, $params) || !in_array($_GET["duration"], get_valid_durations())) {
            return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
        }

        $start = intval($_GET["start"]);
        $end = intval($_GET["end"]);
        $monitor_id = $_GET["monitor_id"];
        $duration = ($_GET["duration"]);
        $shift = ($_GET["shift"]);

        if (isset($shift)) {
            $start = subtract_from_date($start, $duration, 1);
            $end = subtract_from_date($end, $duration, 1);
        }
        $monitor_id = mysqli_real_escape_string($db, $monitor_id);
        $duration = mysqli_real_escape_string($db, $duration);
        #$sql = 'SELECT created, SUM(male) AS males, SUM(female) AS females, monitor_id, FROM_UNIXTIME(created/1000) AS time FROM genders WHERE created <= :end AND created >= :start AND user_id = :user_id AND monitor_id = :monitor_id GROUP BY '.$duration.'(time), monitor_id';
        #$sql = "SELECT created, SUM(value) AS total, monitor_id, FROM_UNIXTIME(created/1000) AS time FROM traffic WHERE created <= $end AND created >= $start AND user_id = \"{$user->id}\" GROUP BY $duration (time), monitor_id";
        $sql = "SELECT created, SUM(male) AS males, SUM(female) AS females, monitor_id, FROM_UNIXTIME(created/1000) AS time FROM genders WHERE created <= $end AND created >= $start AND user_id = \"{$user->id}\" AND monitor_id = \"$monitor_id\" GROUP BY $duration (time), monitor_id";
        $rows = getAllRowsOfQuery($db, $sql);
        return array("status" => 200, "msg" => "Retrieved gender entries in range for monitor", "data" => $rows, "success" => true);
    } else {
        $db = getDB();
        $params = array("male", "female", "monitor_id");
        if (!check_isset_body($_GET, $params)) {
            return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
        }
        $male = $_GET["male"];
        $female = $_GET["female"];
        if (!is_numeric($male) || $male < 0 || !is_numeric($female) || $female < 0) {
            return array("status" => 400, "msg" => "Entries must be valid positive integers", "success" => false);
        }
        $monitor_id = mysqli_real_escape_string($db, $_GET["monitor_id"]);
        $male = mysqli_real_escape_string($db, $male);
        $female = mysqli_real_escape_string($db, $female);
        $sql = "INSERT INTO genders (monitor_id, user_id, male, female, created) VALUES (\"$monitor_id\", \"$user->id\", $male, $female, " . get_micro_time() . ")";
        queryDatabase($db, $sql);
        if (empty(mysqli_error($db))) {
            return array("status" => 200, "msg" => "Inserted entry successfully", "success" => true);
        }
        return array("status" => 500, "msg" => "Server error", "success" => false);

    }
}

function getGenderEntriesAll()
{

    $user = verify_user_token();
    if (is_bool($user)) {

        return array("status" => 401, "success" => false);
    }
    $db = getDB();
    // shift param is not required
    $params = array("start", "end", "duration");
    if (!check_isset_body($_GET, $params) || !in_array($_GET["duration"], get_valid_durations())) {

        return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
    }

    $start = intval($_GET["start"]);
    $end = intval($_GET["end"]);
    $duration = mysqli_real_escape_string($db, $_GET["duration"]);
    $sql = "SELECT created, SUM(male) AS males, SUM(female) as females, monitor_id, FROM_UNIXTIME(created/1000) AS time FROM genders WHERE created <= $end AND created >= $start AND user_id = \"{$user->id}\" GROUP BY $duration (time), monitor_id";
    $rows = getAllRowsOfQuery($db, $sql);
    return array("status" => 200, "msg" => "Retrieved gender entries in range for monitor", "data" => $rows, "success" => true);
}

function getGendersTotal()
{
    $user = verify_user_token();
    if (is_bool($user)) {

        return array("status" => 401, "success" => false);
    }
    $params = array("start", "end");
    if (!check_isset_body($_GET, $params)) {

        return array("status" => 400, "msg" => "Missing required query parameters", "success" => false);
    }

    $start = $_GET["start"];
    $end = $_GET["end"];
    if (!is_numeric($start) || !is_numeric($end) || $start < 0 || $end < 0) {
        return array("status" => 400, "msg" => "Date values must be valid timestamps", "success" => false);
    }
    $db = getDB();
    $start = mysqli_real_escape_string($db, $start);
    $end = mysqli_real_escape_string($db, $end);
    $sql = "SELECT SUM(male) as males, SUM(female) as females FROM genders WHERE created >= $start AND created <= $end AND user_id = \"{$user->id}\"";
    $rows = getAllRowsOfQuery($db, $sql);
    $data = array(
        "males" => isset($rows[0]["males"]) ? $rows[0]["males"] : 0,
        "females" => isset($rows[0]["females"]) ? $rows[0]["females"] : 0
    );
    return array("status" => 200, "msg" => "Retrieved gender entries in range for days", "data" => $data, "success" => true);
}

function insertGendersInBulk()
{
    $user = verify_user_token();
    if (is_bool($user)) {

        return array("status" => 401, "success" => false);
    }
    if (!isPost()) {
        return array("status" => 405);
    }
    $body = json_decode(file_get_contents('php://input'), true);

    $params = array("data", "monitor_id");
    if (!check_isset_body($body, $params)) {
        return array("status" => 400, "msg" => "Missing required body parameters", "success" => false);
    }

    $data = $body["data"];
    if (!is_array($data)) {
        return array("status" => 400, "msg" => "Need appropriately formatted data array for bulk insertion", "success" => false);
    }
    $db = getDB();
    $sql = "INSERT INTO `genders` (monitor_id, user_id, male, female, created) VALUES (";
    $sql_arr = array();
    foreach ($data as $entry) {
        $to_insert = array();
        $e = array("\"" . mysqli_real_escape_string($db, $body["monitor_id"]) . "\"", "\"" . $user->id . "\"", mysqli_real_escape_string($db, $entry["male"]), mysqli_real_escape_string($db, $entry["female"]), mysqli_real_escape_string($db, $entry["created"]));
        foreach ($e as $element) {
            $to_insert[] = $element;
        }
        $sql_arr[] = $sql . implode(', ', $to_insert) . ")";
    }


    foreach ($sql_arr as $query_var) {
        queryDatabase($db, $query_var);
    }
    if (empty(mysqli_error($db))) {
        return array("status" => 200, "msg" => "Bulk entries inserted successfully", "success" => true);
    }

    return array("status" => 500, "msg" => "Server error", "success" => false);


}

