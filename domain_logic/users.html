<?php
function verifyUser($verify_token)
{
    $db = getDB();
    $verify_token = mysqli_real_escape_string($db, $verify_token);
    $sql = "SELECT * from users WHERE verify_token = \"$verify_token\"";
    $res = getAllRowsOfQuery($db, $sql);
    if (!empty($res)) {
        $rows = $res;
        $user_id = mysqli_real_escape_string($db, $rows[0]["id"]);
        $sql_update = 'UPDATE users SET active = true WHERE id = \"$user_id\"';
        queryDatabase($db, $sql);
        http_response_code(200);
        return json_encode(array('msg' => "Verified user account", "success" => true));
    } else {
        http_response_code(400);
        return json_encode(array('msg' => "No user with that token", "success" => false));
    }
}

function loginUser()
{
    if (!isPost()) {
        http_response_code(405);
        return json_encode(array("status" => 405));
    }
    $body = json_decode(file_get_contents('php://input'), true);
    $email = $body["email"];
    $password = $body["password"];
    $db = getDB();
    $email = mysqli_real_escape_string($db, $email);
    $sql = "SELECT * FROM users WHERE email = \"$email\"";
    $res = getAllRowsOfQuery($db, $sql);
    if (!empty($res)) {
        $rows = $res;
        $password_match = password_verify($password, $rows[0]["password"]);
        if ($password_match) {
            http_response_code(200);
            $userId = 'some-user-id';
            // Get our server-side secret key from a secure location.
            $skey = 'super-secret-will-change-later';
            // Enable the following for actual usage
            if (isset($nbf)) {
                $pload['nbf'] = $nbf;
            }
            if (isset($exp)) {
                $pload['exp'] = $exp;
            }
            $token = JWT::encode($rows[0], $skey);
            $data = array("msg" => "Successfully signed in!", "token" => $token, "success" => true);
            return json_encode($data);
        } else {
            http_response_code(400);
            return json_encode(array('msg' => "Email or password incorrect", "success" => false));
        }
    } else {
        http_response_code(400);
        return json_encode(array('msg' => "Email or password incorrect", "success" => false));
    }

}

function createUser()
{
    if (!isPost()) {
        http_response_code(405);
        return json_encode(array("status" => 405));
    }
    $db = getDB();
    $config = getStripeConfig();
    $body = json_decode(file_get_contents('php://input'), true);
    $email = mysqli_real_escape_string($db, $body["email"]);
    $password = mysqli_real_escape_string($db, $body["password"]);
    $plan = $body["plan"];
    $user_id = uniqid();
    $verify_token = uniqid();

    $sql = "SELECT * FROM users WHERE email = \"$email\" AND mailing_list_only = 0";
    $res = getAllRowsOfQuery($db, $sql);
    if (empty($res)) {
        $stripe = new Stripe($config);

        $customer = json_decode($stripe->customer_create($email), true);
        $subscription = json_decode($stripe->customer_subscribe($customer["id"], $plan), true);
        $subscription_item_id = $subscription["items"]["data"][0]["id"];

        # We can successfully create the user in this scenario
        $hash = password_hash($password, PASSWORD_BCRYPT);
        $sql_insert = "REPLACE INTO users (id, email, password, created, customer_id, subscription_id, subscription_item_id, verify_token, mailing_list_only) 
VALUES (\"$user_id\", \"$email\", \"$hash\", " . get_micro_time() . ", \"{$customer['id']}\", \"{$subscription['$id']}\",\"$subscription_item_id\", \"$verify_token\", 0)";
        http_response_code(200);
        return json_encode(array('msg' => "Successfully created user account! Please check your email.", "success" => true));
    } else {
        http_response_code(400);
        return json_encode(array('msg' => "Account already exists with that email", "success" => false));
    }
}

function resetPassword()
{
    if (!isPost()) {
        http_response_code(405);
        return json_encode(array("status" => 405));
    }
    $body = json_decode(file_get_contents('php://input'), true);
    $db = getDB();
    $email = mysqli_escape_string($db, $body["email"]);
    $sql = "SELECT * from password_resets WHERE email = '{$email}'";
    $res = getAllRowsOfQuery($db, $sql);
    if (empty($res)) {
        $reset_id = uniqid();
        $reset_token = uniqid();
        $sql_insert = "INSERT into password_resets (id, email, reset_token, created) VALUES ($reset_id, $email, $reset_token, " . get_micro_time() . ")";
        queryDatabase($db, $sql_insert);
        // SEND MAIL
        http_response_code(200);
        return json_encode(array('msg' => 'Reset request successfully submitted! Follow email instructions', "success" => true));
    } else {
        http_response_code(400);
        return json_encode(array('msg' => "Password reset request already exists!", "success" => false));
    }

}

function resetPasswordByToken()
{
    if (!isPost()) {
        http_response_code(405);
        return json_encode(array("status" => 405));
    }
    $body = json_decode(file_get_contents('php://input'), true);

}

